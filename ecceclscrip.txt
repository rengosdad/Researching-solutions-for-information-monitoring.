const API_KEY = "API genimini ";
function onOpen() {
  var ui = SpreadsheetApp.getUi();
  ui.createMenu('üçÑ AI Quy Tr√¨nh N·∫•m')
    .addItem('L·∫≠p quy tr√¨nh tr·ªìng', 'lapQuyTrinh')
    .addItem('L·∫≠p l·ªô tr√¨nh chi ti·∫øt', 'lapLoTrinh')
    .addToUi();
}
// H√†m g·ª≠i y√™u c·∫ßu c√≥ c∆° ch·∫ø th·ª≠ l·∫°i n·∫øu qu√° t·∫£i
function fetchWithRetry(url, options, maxRetries = 3) {
  let retries = 0;
  while (retries < maxRetries) {
    try {
      const response = UrlFetchApp.fetch(url, options);
      if (response.getResponseCode() === 200) return response;
    } catch (e) {
      if (e.toString().includes("503") || e.toString().includes("429")) {
        retries++;
        Utilities.sleep(3000 * retries);
      } else {
        throw e;
      }
    }
  }
  throw new Error("Google AI ƒëang b·∫≠n. Vui l√≤ng th·ª≠ l·∫°i sau 1 ph√∫t.");
}
function lapQuyTrinh() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  const tenNam = sheet.getRange("A2").getValue(); // Nh·∫≠p t√™n n·∫•m ·ªü √¥ A2
 
  if (!tenNam) return SpreadsheetApp.getUi().alert("H√£y nh·∫≠p t√™n lo·∫°i n·∫•m v√†o √¥ A2 (V√≠ d·ª•: N·∫•m M·ªëi ƒêen)");
  // X√≥a d·ªØ li·ªáu c≈© t·ª´ d√≤ng 4 tr·ªü ƒëi ƒë·ªÉ b·∫£ng s·∫°ch s·∫Ω
  var lastRow = sheet.getLastRow();
  if (lastRow > 3) {
    sheet.getRange(4, 1, lastRow - 3, 6).clearContent().clearFormat();
  }
  try {
    // 1. T·ª± ƒë·ªông t√¨m model (gi·ªØ nguy√™n logic d√≤ t√¨m model t·ªët nh·∫•t)
    const modelUrl = `https://generativelanguage.googleapis.com/v1beta/models?key=${API_KEY}`;
    const resModels = fetchWithRetry(modelUrl, { "method": "get" });
    const modelsJson = JSON.parse(resModels.getContentText());
   
    let selectedModel = modelsJson.models.find(m => m.name.includes("gemini-1.5-flash"))?.name ||
                        modelsJson.models.find(m => m.supportedGenerationMethods.includes("generateContent"))?.name;
    // 2. Prompt chuy√™n bi·ªát ƒë·ªÉ t·∫°o L·ªò TR√åNH (Danh s√°ch nhi·ªÅu d√≤ng)
    const prompt = `L·∫≠p b·∫£ng quy tr√¨nh k·ªπ thu·∫≠t tr·ªìng n·∫•m "${tenNam}" chi ti·∫øt t·ª´ A-Z.
    Tr·∫£ v·ªÅ k·∫øt qu·∫£ d∆∞·ªõi d·∫°ng JSON l√† m·ªôt M·∫£ng (Array) c√°c b∆∞·ªõc.
    C√°c tr∆∞·ªùng (key) b·∫Øt bu·ªôc:
    - "giaidoan" (V√≠ d·ª•: X·ª≠ l√Ω nguy√™n li·ªáu, C·∫•y gi·ªëng, ChƒÉm s√≥c...)
    - "thoigian" (V√≠ d·ª•: Ng√†y 1-3, Ng√†y 4...)
    - "nhietdo" (V√≠ d·ª•: 28-32 ƒë·ªô C)
    - "doam" (V√≠ d·ª•: 65-70%)
    - "congviec" (M√¥ t·∫£ chi ti·∫øt c√¥ng vi·ªác c·∫ßn l√†m)
    - "luuy" (L∆∞u √Ω quan tr·ªçng)
   
    Ch·ªâ tr·∫£ v·ªÅ JSON thu·∫ßn, kh√¥ng k√®m markdown.`;
   
    const url = `https://generativelanguage.googleapis.com/v1beta/${selectedModel}:generateContent?key=${API_KEY}`;
    const payload = { "contents": [{ "parts": [{ "text": prompt }] }] };
    const options = { "method": "post", "contentType": "application/json", "payload": JSON.stringify(payload) };
   
    const response = fetchWithRetry(url, options);
    const resultText = JSON.parse(response.getContentText()).candidates[0].content.parts[0].text;
    const cleanJson = resultText.replace(/```json/g, "").replace(/```/g, "").trim();
   
    const dataList = JSON.parse(cleanJson); // ƒê√¢y l√† m·ªôt danh s√°ch (Array)
    // 3. X·ª≠ l√Ω d·ªØ li·ªáu ƒë·ªÉ ghi v√†o b·∫£ng
    // T·∫°o ti√™u ƒë·ªÅ
    const headers = [["Giai ƒëo·∫°n", "Th·ªùi gian", "Nhi·ªát ƒë·ªô", "ƒê·ªô ·∫©m", "C√¥ng vi·ªác th·ª±c hi·ªán", "L∆∞u √Ω k·ªπ thu·∫≠t"]];
    sheet.getRange("A4:F4").setValues(headers)
         .setFontWeight("bold")
         .setBackground("#4caf50") // M√†u xanh l√° c√¢y n√¥ng nghi·ªáp
         .setFontColor("white");
    // Chuy·ªÉn JSON th√†nh m·∫£ng 2 chi·ªÅu ƒë·ªÉ ghi v√†o Sheet
    let rows = [];
    dataList.forEach(item => {
      rows.push([item.giaidoan, item.thoigian, item.nhietdo, item.doam, item.congviec, item.luuy]);
    });
    if (rows.length > 0) {
      sheet.getRange(5, 1, rows.length, 6).setValues(rows)
           .setWrap(true) // T·ª± ƒë·ªông xu·ªëng d√≤ng
           .setVerticalAlignment("middle");
          
      // K·∫ª khung cho ƒë·∫πp
      sheet.getRange(4, 1, rows.length + 1, 6).setBorder(true, true, true, true, true, true);
     
      // Ch·ªânh ƒë·ªô r·ªông c·ªôt cho d·ªÖ ƒë·ªçc
      sheet.setColumnWidth(1, 120); // Giai ƒëo·∫°n
      sheet.setColumnWidth(5, 300); // C√¥ng vi·ªác (c·∫ßn r·ªông nh·∫•t)
      sheet.setColumnWidth(6, 200); // L∆∞u √Ω
    }
   
    SpreadsheetApp.getUi().alert("‚úÖ ƒê√£ l·∫≠p xong quy tr√¨nh tr·ªìng: " + tenNam);
  } catch (e) {
    SpreadsheetApp.getUi().alert("L·ªói: " + e.toString());
  }
}
function lapLoTrinh() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  const tenNam = sheet.getRange("A2").getValue(); // Nh·∫≠p t√™n n·∫•m ·ªü √¥ A2

  if (!tenNam) return SpreadsheetApp.getUi().alert("H√£y nh·∫≠p t√™n lo·∫°i n·∫•m v√†o √¥ A2 (V√≠ d·ª•: N·∫•m R∆°m)");

  // Kh√¥ng x√≥a d·ªØ li·ªáu c≈©, m√† t√¨m v·ªã tr√≠ b·∫Øt ƒë·∫ßu m·ªõi (sau b·∫£ng tr∆∞·ªõc n·∫øu c√≥)
  var lastRow = sheet.getLastRow();
  var startRow = lastRow > 3 ? lastRow + 2 : 4; // B·∫Øt ƒë·∫ßu t·ª´ d√≤ng 4 n·∫øu tr·ªëng, ho·∫∑c sau lastRow +1

  try {
    // 1. T·ª± ƒë·ªông t√¨m model (gi·ªØ nguy√™n logic d√≤ t√¨m model t·ªët nh·∫•t)
    const modelUrl = `https://generativelanguage.googleapis.com/v1beta/models?key=${API_KEY}`;
    const resModels = fetchWithRetry(modelUrl, { "method": "get" });
    const modelsJson = JSON.parse(resModels.getContentText());

    let selectedModel = modelsJson.models.find(m => m.name.includes("gemini-1.5-flash"))?.name ||
                        modelsJson.models.find(m => m.supportedGenerationMethods.includes("generateContent"))?.name;

    // 2. Prompt chuy√™n bi·ªát ƒë·ªÉ t·∫°o l·ªô tr√¨nh linh ho·∫°t t√πy lo·∫°i n·∫•m
    const prompt = `T√¨m th√¥ng tin v√† l·∫≠p l·ªô tr√¨nh tr·ªìng n·∫•m "${tenNam}" chi ti·∫øt theo ng√†y, d·ª±a tr√™n quy tr√¨nh k·ªπ thu·∫≠t chu·∫©n. 
    S·ªë ng√†y linh ho·∫°t t√πy theo lo·∫°i n·∫•m (v√≠ d·ª•: m·ªôt s·ªë lo·∫°i ch·ªâ 2 ƒë·ª£t thu ho·∫°ch, c√≥ th·ªÉ ng·∫Øn h∆°n 30 ng√†y; m·ªôt s·ªë lo·∫°i d√†i h∆°n). 
    K·∫øt th√∫c l·ªô tr√¨nh khi ho√†n t·∫•t v·ª• tr·ªìng (bao g·ªìm v·ªá sinh cu·ªëi v·ª•).
    Tr·∫£ v·ªÅ k·∫øt qu·∫£ d∆∞·ªõi d·∫°ng JSON l√† m·ªôt M·∫£ng (Array) c√°c ng√†y (t·ª´ ng√†y 1 ƒë·∫øn ng√†y cu·ªëi c√πng ph√π h·ª£p).
    C√°c tr∆∞·ªùng (key) b·∫Øt bu·ªôc cho m·ªói ng√†y:
    - "ngay" (S·ªë ng√†y: 1, 2, 3,... ƒë·∫øn ng√†y cu·ªëi)
    - "giaidoan" (V√≠ d·ª•: ƒê·ª£t 1: ·ª¶ meo, ƒê·ª£t 1: Nu√¥i t∆°, ƒê·ª£t 2: Thu ho·∫°ch,...)
    - "temp_min" (Nhi·ªát ƒë·ªô t·ªëi thi·ªÉu, v√≠ d·ª•: 32 ho·∫∑c -- n·∫øu kh√¥ng √°p d·ª•ng)
    - "temp_max" (Nhi·ªát ƒë·ªô t·ªëi ƒëa, v√≠ d·ª•: 35 ho·∫∑c -- n·∫øu kh√¥ng √°p d·ª•ng)
    - "hum_min" (ƒê·ªô ·∫©m t·ªëi thi·ªÉu, v√≠ d·ª•: 75 ho·∫∑c -- n·∫øu kh√¥ng √°p d·ª•ng)
    - "hum_max" (ƒê·ªô ·∫©m t·ªëi ƒëa, v√≠ d·ª•: 80 ho·∫∑c -- n·∫øu kh√¥ng √°p d·ª•ng)
    - "nhiemvu" (Nhi·ªám v·ª• ho·∫∑c nh·∫Øc nh·ªü chi ti·∫øt cho ng√†y ƒë√≥, v√≠ d·ª•: ƒê·∫≠y k√≠n nilon, gi·ªØ ·∫•m ƒë·ªÉ h·ªìi s·ª©c meo.)

    Ch·ªâ tr·∫£ v·ªÅ JSON thu·∫ßn, kh√¥ng k√®m markdown hay gi·∫£i th√≠ch.`;

    const url = `https://generativelanguage.googleapis.com/v1beta/${selectedModel}:generateContent?key=${API_KEY}`;
    const payload = { "contents": [{ "parts": [{ "text": prompt }] }] };
    const options = { "method": "post", "contentType": "application/json", "payload": JSON.stringify(payload) };

    const response = fetchWithRetry(url, options);
    const resultText = JSON.parse(response.getContentText()).candidates[0].content.parts[0].text;
    const cleanJson = resultText.replace(/```json/g, "").replace(/```/g, "").trim();

    const dataList = JSON.parse(cleanJson); // ƒê√¢y l√† m·ªôt danh s√°ch (Array) v·ªõi s·ªë ph·∫ßn t·ª≠ linh ho·∫°t

    // 3. X·ª≠ l√Ω d·ªØ li·ªáu ƒë·ªÉ ghi v√†o b·∫£ng
    // T·∫°o ti√™u ƒë·ªÅ
    const headers = [["Ng√†y", "Giai ƒëo·∫°n", "Temp Min", "Temp Max", "Hum Min", "Hum Max", "Nhi·ªám v·ª• AI nh·∫Øc nh·ªü"]];
    sheet.getRange(startRow, 1, 1, 7).setValues(headers)
         .setFontWeight("bold")
         .setBackground("#4caf50") // M√†u xanh l√° c√¢y n√¥ng nghi·ªáp
         .setFontColor("white");

    // Chuy·ªÉn JSON th√†nh m·∫£ng 2 chi·ªÅu ƒë·ªÉ ghi v√†o Sheet
    let rows = [];
    dataList.forEach(item => {
      rows.push([item.ngay, item.giaidoan, item.temp_min, item.temp_max, item.hum_min, item.hum_max, item.nhiemvu]);
    });

    if (rows.length > 0) {
      sheet.getRange(startRow + 1, 1, rows.length, 7).setValues(rows)
           .setWrap(true) // T·ª± ƒë·ªông xu·ªëng d√≤ng
           .setVerticalAlignment("middle");

      // K·∫ª khung cho ƒë·∫πp
      sheet.getRange(startRow, 1, rows.length + 1, 7).setBorder(true, true, true, true, true, true);

      // Ch·ªânh ƒë·ªô r·ªông c·ªôt cho d·ªÖ ƒë·ªçc
      sheet.setColumnWidth(1, 80); // Ng√†y
      sheet.setColumnWidth(2, 150); // Giai ƒëo·∫°n
      sheet.setColumnWidth(7, 300); // Nhi·ªám v·ª• (c·∫ßn r·ªông nh·∫•t)
    }

    SpreadsheetApp.getUi().alert("‚úÖ ƒê√£ l·∫≠p xong l·ªô tr√¨nh chi ti·∫øt cho: " + tenNam + " (T·ªïng " + rows.length + " ng√†y)");
  } catch (e) {
    SpreadsheetApp.getUi().alert("L·ªói: " + e.toString());
  }

}
